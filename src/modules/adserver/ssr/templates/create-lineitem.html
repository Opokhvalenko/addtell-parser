<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Create Line Item</title>
  <style>
    :root { color-scheme: light dark; }
    html, body { margin: 0; background: transparent !important; }
  </style>
</head>
<body>
  <div id="li-form-root"></div>

  <script>
    (function () {
      const host = document.getElementById('li-form-root');
      const shadow = host.attachShadow({ mode: 'open' });

      const themeRoot = document.createElement('div');
      const prefersDark = matchMedia('(prefers-color-scheme: dark)').matches;
      if (prefersDark) themeRoot.classList.add('dark');
      shadow.appendChild(themeRoot);

      const tw = document.createElement('link');
      tw.rel = 'stylesheet';
      tw.href = '/public/assets/tw-embed.css?v=4';
      tw.onerror = () => {
        const s = document.createElement('style');
        s.textContent = '@import "/tailwind.css";';
        shadow.appendChild(s);
      };
      shadow.appendChild(tw);

      const wrap = document.createElement('div');
      wrap.className = 'max-w-3xl mx-auto p-6';
      wrap.innerHTML = `
        <!-- Заголовок показуємо тільки коли сторінка відкрита напряму -->
        <div id="li-header" class="mb-6">
          <h1 class="text-3xl font-bold mb-2 text-gray-900 dark:text-gray-100">
            Create Advertisement (Line Item)
          </h1>
        </div>

        <!-- картка форми -->
        <div class="panel text-slate-900 dark:text-slate-100 p-6 md:p-8">
          <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">
            Welcome, <strong class="text-blue-600">%%USER_EMAIL%%</strong>
          </p>

          <form id="li-form" class="space-y-6" method="post" action="/ads/lineitems"
                enctype="multipart/form-data" novalidate>
            <input type="hidden" name="csrfToken" value="%%CSRF_TOKEN%%" />

            <div>
              <label class="block text-sm font-medium mb-2">Name</label>
              <input name="name" required class="mt-1 w-full" placeholder="Enter ad name" />
              <div class="err" data-err="name"></div>
            </div>

            <div>
              <label class="block text-sm font-medium mb-2">
                Sizes (e.g., <code class="bg-gray-200 dark:bg-slate-700 px-2 py-1 rounded text-blue-600">300x250,300x600</code>)
              </label>
              <input name="sizes" required pattern="^\\s*\\d+x\\d+(\\s*,\\s*\\d+x\\d+)*\\s*$"
                     class="mt-1 w-full" placeholder="300x250,728x90" />
              <p class="hint">Comma-separated list supported.</p>
              <div class="err" data-err="sizes"></div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium mb-2">Min CPM</label>
                <input name="minCpm" type="number" step="0.01" min="0" value="0" required class="mt-1 w-full" />
                <div class="err" data-err="minCpm"></div>
              </div>
              <div>
                <label class="block text-sm font-medium mb-2">Max CPM</label>
                <input name="maxCpm" type="number" step="0.01" min="0" class="mt-1 w-full" />
                <div class="err" data-err="maxCpm"></div>
              </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium mb-2">GEO (comma-separated)</label>
                <input name="geo" placeholder="US,UA,PL" class="mt-1 w-full" />
              </div>
              <div>
                <label class="block text-sm font-medium mb-2">Ad type</label>
                <select name="adType" class="mt-1 w-full">
                  <option value="banner">banner</option>
                  <option value="native">native</option>
                  <option value="video">video</option>
                </select>
              </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium mb-2">Start</label>
                <input name="startDate" type="date" class="mt-1 w-full" />
              </div>
              <div>
                <label class="block text-sm font-medium mb-2">End</label>
                <input name="endDate" type="date" class="mt-1 w-full" />
              </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium mb-2">Frequency per day</label>
                <input name="frequencyPerDay" type="number" min="0" value="0" class="mt-1 w-full" />
              </div>
              <div class="flex items-center gap-3 pt-7">
                <input id="active" name="active" type="checkbox" class="h-4 w-4 rounded" checked />
                <label for="active" class="text-sm">Active</label>
              </div>
            </div>

            <div>
              <label class="block text-sm font-medium mb-2">Click-through URL (optional)</label>
              <input name="clickUrl" type="url" placeholder="https://example.com" class="mt-1 w-full" />
              <div class="err" data-err="clickUrl"></div>
            </div>

            <div>
              <div class="flex items-center justify-between mb-2">
                <label class="block text-sm font-medium">Inline HTML creative (optional)</label>
                <button type="button" id="previewHtmlBtn" class="btn-ghost text-sm">Preview</button>
              </div>
              <textarea name="html" rows="4" class="mt-1 w-full"
                        placeholder='&lt;a href="https://…"&gt;&lt;img …&gt;&lt;/a&gt;'></textarea>
              <div class="err" data-err="html"></div>
              <div id="htmlPreview" class="mt-3 hidden border border-gray-300 dark:border-slate-600 rounded-lg overflow-hidden">
                <iframe title="creative-preview"
                        sandbox="allow-scripts"
                        referrerpolicy="no-referrer"
                        style="width:100%;height:160px;border:0;"></iframe>
              </div>
            </div>

            <div>
              <label class="block text-sm font-medium mb-2">Creative file (PNG/JPG/GIF, optional)</label>
              <input id="file" name="creative" type="file" accept="image/*"
                     class="mt-1 w-full file:bg-gray-600 file:border-0 file:rounded file:px-3 file:py-1 file:text-white file:hover:bg-gray-500 file:transition-colors" />
              <div id="preview" class="mt-3 hidden">
                <img alt="preview" class="max-h-40 rounded-lg border border-gray-300 dark:border-slate-600" />
                <p class="hint mt-2" id="imgInfo"></p>
              </div>
              <div class="err" data-err="creative"></div>
              <p class="text-xs text-gray-600 dark:text-gray-400 mt-2">If HTML is provided, the file is optional.</p>
            </div>

            <div id="msg" class="text-sm" aria-live="polite"></div>

            <button id="submitBtn"
              class="w-full px-6 py-3 rounded-lg bg-gradient-to-r from-blue-600 to-purple-600 text-white font-medium
                     hover:from-blue-700 hover:to-purple-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-all duration-200 shadow-lg">
              <span class="flex items-center justify-center">
                <span class="mr-2">✨</span> Create line item
              </span>
            </button>
          </form>
        </div>
      `;
      themeRoot.appendChild(wrap);

      const headerEl = wrap.querySelector('#li-header');
      const inIframe = window.top !== window;
      if (inIframe && headerEl) headerEl.remove();


      const $ = (sel) => wrap.querySelector(sel);
      const form = $('#li-form');
      const msg = $('#msg');
      const submitBtn = $('#submitBtn');
      const fileInput = $('#file');
      const previewBox = $('#preview');
      const previewImg = $('#preview img');
      const imgInfo = $('#imgInfo');
      const htmlTextarea = form.querySelector('textarea[name="html"]');
      const htmlPreviewWrap = $('#htmlPreview');
      const htmlPreviewFrame = $('#htmlPreview iframe');
      const previewHtmlBtn = $('#previewHtmlBtn');

      let parentOrigin = '*';
      try { parentOrigin = new URL(document.referrer).origin; } catch {}

      function applyTheme(isDark) {
        themeRoot.classList.toggle('dark', !!isDark);
        if (isDark) themeRoot.setAttribute('data-theme', 'dark');
        else themeRoot.removeAttribute('data-theme');
        resize();
        try { window.parent.postMessage({ type: 'ack' }, parentOrigin); } catch {}
      }

      window.addEventListener('message', (ev) => {
        if (parentOrigin !== '*' && ev.origin !== parentOrigin) return;
        const d = ev.data || {};
        if (d.type === 'theme') applyTheme(!!d.dark);
      });

      let raf = 0;
      const resize = () => {
        cancelAnimationFrame(raf);
        raf = requestAnimationFrame(() => {
          const h = Math.ceil(wrap.getBoundingClientRect().height) + 16;
          parent.postMessage({ type: 'resize', height: h }, '*');
        });
      };
      new ResizeObserver(resize).observe(wrap);
      window.addEventListener('load', () => {
        resize();
        try { window.parent.postMessage({ type: 'ready' }, parentOrigin); } catch {}
      });
      tw.addEventListener('load', resize);
      if (document.fonts && document.fonts.ready) {
        document.fonts.ready.then(resize).catch(() => {});
      }

      const SIZE_LIST_RE = /^\s*\d+x\d+(?:\s*,\s*\d+x\d+)*\s*$/i;
      const BAD_HTML_RE  = /<script\b|on\w+\s*=|javascript:/i;
      const err = (name, text='') => {
        const n = wrap.querySelector('[data-err="'+name+'"]');
        if (n) n.textContent = text || '';
      };
      const parseSizes = (str) => (String(str||'')
        .split(',').map(s=>s.trim()).filter(Boolean)
        .map(s => { const [w,h]=s.toLowerCase().split('x').map(Number); return {w,h}; })
        .filter(s=>Number.isFinite(s.w)&&Number.isFinite(s.h)));

      const buildSafeHtml = (raw) => {
        let s = String(raw || '');
        s = s.replace(/<script[\s\S]*?<\/script>/gi, '');
        s = s.replace(/\son\w+\s*=\s*(".*?"|'.*?'|[^\s>]+)/gi, '');
        s = s.replace(/(["'])\s*javascript\s*:/gi, '$1#');
        s = s.replace(/url\((["']?)\s*javascript\s*:[\s\S]*?\1\)/gi, 'url(#)');

        const csp = `default-src 'none'; img-src https: data: blob:; style-src 'unsafe-inline'; script-src 'unsafe-inline';`;
        return `<!doctype html>
<meta charset="utf-8">
<meta http-equiv="Content-Security-Policy" content="${csp}">
<style>html,body{margin:0;padding:0}</style>${s}`;
      };
      const showHtmlPreview = () => {
        const val = htmlTextarea.value.trim();
        if (!val) { htmlPreviewWrap.classList.add('hidden'); return; }
        if (BAD_HTML_RE.test(val)) { err('html','HTML contains disallowed content.'); htmlPreviewWrap.classList.add('hidden'); return; }
        err('html','');
        htmlPreviewWrap.classList.remove('hidden');
        htmlPreviewFrame.setAttribute('sandbox', 'allow-scripts');
        htmlPreviewFrame.srcdoc = buildSafeHtml(val);
        resize();
      };
      previewHtmlBtn.addEventListener('click', showHtmlPreview);
      htmlTextarea.addEventListener('input', () => { err('html',''); });

      fileInput.addEventListener('change', () => {
        const f = fileInput.files && fileInput.files[0];
        const sizesVal = form.elements.namedItem('sizes')?.value || '';
        const allow = parseSizes(sizesVal);
        err('creative','');

        if (!f) { previewBox.classList.add('hidden'); return; }
        if (!f.type.startsWith('image/')) { fileInput.value=''; err('creative','File must be an image.'); return; }
        if (f.size > 10 * 1024 * 1024) { fileInput.value=''; err('creative','File is too large (max 10MB).'); return; }

        const url = URL.createObjectURL(f);
        previewImg.onload = () => {
          const w = previewImg.naturalWidth, h = previewImg.naturalHeight;
          imgInfo.textContent = `Image: ${w}×${h}px`;
          if (allow.length && !allow.some(s => s.w === w && s.h === h)) {
            err('creative', `Warning: ${w}×${h}px doesn't match Sizes list.`);
          }
          resize();
        };
        previewImg.onerror = () => { err('creative','Preview failed.'); };
        previewImg.src = url;
        previewBox.classList.remove('hidden');
        resize();
      });

  
      form.addEventListener('input', (e) => {
        const t = e.target;
        if (!t || !t.name) return;
        if (t.name === 'name') err('name','');
        if (t.name === 'sizes') err('sizes', SIZE_LIST_RE.test(t.value) ? '' : 'Example: 300x250,300x600');
        if (t.name === 'geo') t.value = String(t.value).split(',').map(s=>s.trim().toUpperCase()).filter(Boolean).join(',');
        if (t.name === 'maxCpm' || t.name === 'minCpm') {
          const min = parseFloat(form.minCpm.value || '0');
          const max = parseFloat(form.maxCpm.value || '');
          const bad = !Number.isNaN(min) && !Number.isNaN(max) && max > 0 && max < min;
          err('maxCpm', bad ? 'Max CPM must be ≥ Min CPM' : '');
        }
        if (t.name === 'clickUrl') err('clickUrl','');
        resize();
      });

      form.addEventListener('submit', async (ev) => {
        ev.preventDefault();
        ['name','sizes','maxCpm','clickUrl','creative','html'].forEach(n=>err(n,''));
        msg.textContent = '';
        submitBtn.disabled = true;
        try {
          const fd = new FormData(form);
          const nameVal  = (form.elements.namedItem('name')?.value  || '').trim();
          const sizesVal = (form.elements.namedItem('sizes')?.value || '').trim();
          if (!nameVal) { err('name','Required.'); submitBtn.disabled=false; return; }
          if (!sizesVal || !SIZE_LIST_RE.test(sizesVal)) { err('sizes','Example: 300x250,300x600'); submitBtn.disabled=false; return; }
          fd.set('name', nameVal); fd.set('sizes', sizesVal);

          const htmlVal  = (form.elements.namedItem('html')?.value || '').trim();
          const clickVal = (form.elements.namedItem('clickUrl')?.value || '').trim();
          const hasFile  = fileInput && fileInput.files && fileInput.files[0];

          if (!htmlVal && !hasFile) { err('creative','Provide HTML or upload a file.'); submitBtn.disabled=false; return; }
          if (htmlVal) {
            if (BAD_HTML_RE.test(htmlVal)) {
              err('html','HTML contains disallowed content.'); submitBtn.disabled=false; return;
            }
            fd.set('html', htmlVal);
          }
          if (clickVal && !/^https?:\/\//i.test(clickVal)) { err('clickUrl','URL must start with http/https'); submitBtn.disabled=false; return; }

          const geoEl = form.elements.namedItem('geo');
          if (geoEl && geoEl.value != null) {
            const g = String(geoEl.value).split(',').map(s=>s.trim().toUpperCase()).filter(Boolean).join(',');
            fd.set('geo', g);
          }

          const res = await fetch(form.action, { method:'POST', body:fd, credentials:'include' });
          const ct  = res.headers.get('content-type') || '';
          const raw = await res.text();
          let data  = null; if (ct.includes('application/json')) { try { data = JSON.parse(raw); } catch {} }

          if (!res.ok) {
            msg.textContent = (data && (data.message || data.error)) || raw || 'Failed to create line item';
          } else {
            const id = data?.id ?? (() => { try { return JSON.parse(raw).id; } catch { return null; } })();
            msg.innerHTML = id ? `Created! ID: <code>${id}</code>` : 'Line item created. Thank you!';
            form.reset();
            if (previewImg.src && previewImg.src.startsWith('blob:')) { try { URL.revokeObjectURL(previewImg.src); } catch {} }
            previewImg.src = ''; previewBox.classList.add('hidden');
            htmlPreviewWrap.classList.add('hidden');
            resize();
          }
        } finally {
          submitBtn.disabled = false;
        }
      });
    })();
  </script>
</body>
</html>