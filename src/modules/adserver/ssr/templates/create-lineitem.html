<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Create Line Item</title>
</head>
<body class="bg-slate-50 text-slate-900">
  <div class="max-w-3xl mx-auto p-6">
    <h1 class="text-2xl font-bold mb-2">Створення реклами (Line Item)</h1>
    <p class="mb-4 text-sm text-slate-600">Вітаємо, <strong>%%USER_EMAIL%%</strong></p>

    <div id="li-form-root"></div>
  </div>

  <script>
    (function () {
      const host = document.getElementById('li-form-root');
      const shadow = host.attachShadow({ mode: 'open' });

      const tw = document.createElement('link');
      tw.rel = 'stylesheet';
      tw.href = 'https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css';
      shadow.appendChild(tw);

      const wrap = document.createElement('div');
      wrap.className = 'bg-white rounded-2xl shadow p-6';
      wrap.innerHTML = `
        <form id="li-form" class="space-y-5" method="post" action="/ads/lineitems" enctype="multipart/form-data" novalidate>
          <div>
            <label class="block text-sm font-medium mb-1">Назва</label>
            <input name="name" required class="mt-1 w-full border rounded p-2" />
          </div>

          <div>
            <label class="block text-sm font-medium mb-1">Розміри (напр. <code>300x250,300x600</code>)</label>
            <input name="sizes" required pattern="^\\s*\\d+x\\d+(\\s*,\\s*\\d+x\\d+)*\\s*$" class="mt-1 w-full border rounded p-2" />
            <p class="text-xs text-slate-500 mt-1">Підтримується список через кому.</p>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium mb-1">Мінімальний CPM</label>
              <input name="minCpm" type="number" step="0.01" min="0" value="0" required class="mt-1 w-full border rounded p-2" />
            </div>
            <div>
              <label class="block text-sm font-medium mb-1">Максимальний CPM</label>
              <input name="maxCpm" type="number" step="0.01" min="0" class="mt-1 w-full border rounded p-2" />
            </div>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium mb-1">GEO (через кому)</label>
              <input name="geo" placeholder="US,UA,PL" class="mt-1 w-full border rounded p-2" />
            </div>
            <div>
              <label class="block text-sm font-medium mb-1">Тип реклами</label>
              <select name="adType" class="mt-1 w-full border rounded p-2">
                <option value="banner">banner</option>
                <option value="native">native</option>
                <option value="video">video</option>
              </select>
            </div>
          </div>

          <div>
            <label class="block text-sm font-medium mb-1">Частота показів на користувача (на день)</label>
            <input name="frequencyPerDay" type="number" min="0" value="0" class="mt-1 w-full border rounded p-2" />
          </div>

          <div>
            <label class="block text-sm font-medium mb-1">Посилання переходу (optional)</label>
            <input name="clickUrl" type="url" placeholder="https://example.com" class="mt-1 w-full border rounded p-2" />
          </div>

          <div>
            <label class="block text-sm font-medium mb-1">Inline HTML creative (optional)</label>
            <textarea name="html" rows="4" class="mt-1 w-full border rounded p-2"
              placeholder='&lt;a href="https://…"&gt;&lt;img …&gt;&lt;/a&gt;'></textarea>
          </div>

          <div>
            <label class="block text-sm font-medium mb-1">Файл креатива (PNG/JPG/GIF, optional)</label>
            <input id="file" name="creative" type="file" accept="image/*" class="mt-1 w-full" />
            <div id="preview" class="mt-2 hidden">
              <img alt="preview" class="max-h-40 rounded border"/>
            </div>
            <p class="text-xs text-slate-500 mt-1">Якщо заповнено HTML — файл не обов’язковий.</p>
          </div>

          <div id="msg" class="text-sm"></div>

          <button id="submitBtn" class="px-4 py-2 rounded bg-indigo-600 text-white hover:bg-indigo-700">
            Створити
          </button>
        </form>
      `;
      shadow.appendChild(wrap);

      const $ = (sel) => wrap.querySelector(sel);
      const form = $('#li-form');
      const msg = $('#msg');
      const submitBtn = $('#submitBtn');
      const fileInput = $('#file');
      const previewBox = $('#preview');
      const previewImg = $('#preview img');

      function postResize() {
        const h = document.documentElement.scrollHeight;
        parent.postMessage({ type: 'resize', height: h }, '*');
      }
      new ResizeObserver(postResize).observe(document.body);
      window.addEventListener('load', postResize);

      fileInput.addEventListener('change', () => {
        const f = fileInput.files && fileInput.files[0];
        if (!f) { previewBox.classList.add('hidden'); return; }
        if (f.size > 10 * 1024 * 1024) {
          fileInput.value = '';
          showError('Файл завеликий (макс 10MB).');
          return;
        }
        if (previewImg.src && previewImg.src.startsWith('blob:')) {
          try { URL.revokeObjectURL(previewImg.src); } catch {}
        }
        const url = URL.createObjectURL(f);
        previewImg.src = url;
        previewBox.classList.remove('hidden');
        postResize();
      });

      function showError(text) {
        msg.className = 'text-red-600';
        msg.textContent = text;
      }
      function showSuccess(text) {
        msg.className = 'text-emerald-600';
        msg.textContent = text;
      }

      const SIZE_LIST_RE = /^\s*\d+x\d+(?:\s*,\s*\d+x\d+)*\s*$/i;
      const BAD_HTML_RE = /<script\b|on\w+\s*=|javascript:/i;

      form.addEventListener('input', (e) => {
        if (!e.target) return;

        if (e.target.name === 'sizes') {
          e.target.setCustomValidity(SIZE_LIST_RE.test(e.target.value) ? '' : 'Приклад: 300x250,300x600');
        }

        if (e.target.name === 'geo') {
          e.target.value = e.target.value
            .split(',')
            .map(s => s.trim().toUpperCase())
            .filter(Boolean)
            .join(',');
        }

        if (e.target.name === 'maxCpm' || e.target.name === 'minCpm') {
          const min = parseFloat(form.minCpm.value || '0');
          const max = parseFloat(form.maxCpm.value || '');
          if (!isNaN(min) && !isNaN(max) && max > 0 && max < min) {
            form.maxCpm.setCustomValidity('Max CPM має бути ≥ Min CPM');
          } else {
            form.maxCpm.setCustomValidity('');
          }
        }
      });

      form.addEventListener('submit', async (ev) => {
        ev.preventDefault();
        msg.textContent = '';
        submitBtn.disabled = true;

        try {
          const fd = new FormData(form);

          const nameVal  = (form.elements.namedItem('name')  || { value: '' }).value?.trim?.() ?? '';
          const sizesVal = (form.elements.namedItem('sizes') || { value: '' }).value?.trim?.() ?? '';
          if (!nameVal || !sizesVal) {
            showError('name і sizes обовʼязкові'); submitBtn.disabled = false; return;
          }
          if (!SIZE_LIST_RE.test(sizesVal)) {
            showError('sizes: приклад 300x250,300x600'); submitBtn.disabled = false; return;
          }
          fd.set('name', nameVal);
          fd.set('sizes', sizesVal);

          const htmlVal = (form.elements.namedItem('html') || { value: '' }).value?.trim?.() ?? '';
          const clickVal = (form.elements.namedItem('clickUrl') || { value: '' }).value?.trim?.() ?? '';
          const hasFile = fileInput && fileInput.files && fileInput.files[0];

          if (!htmlVal && !hasFile) {
            showError('Додайте HTML креатив або файл зображення.'); submitBtn.disabled = false; return;
          }
          if (htmlVal) {
            if (BAD_HTML_RE.test(htmlVal)) {
              showError('HTML містить заборонений вміст (script/inline handlers/javascript:).'); submitBtn.disabled = false; return;
            }
            fd.set('html', htmlVal);
          }
          if (clickVal && !/^https?:\/\//i.test(clickVal)) {
            showError('Посилання має починатися з http/https'); submitBtn.disabled = false; return;
          }

          const geoEl = form.elements.namedItem('geo');
          if (geoEl && geoEl.value != null) {
            const g = String(geoEl.value)
              .split(',').map(s => s.trim().toUpperCase()).filter(Boolean).join(',');
            fd.set('geo', g);
          }

          const res = await fetch(form.action, {
            method: 'POST',
            body: fd,
            credentials: 'include',
          });

          const ct = res.headers.get('content-type') || '';
          const raw = await res.text();
          let data = null;
          if (ct.includes('application/json')) { try { data = JSON.parse(raw); } catch {} }

          if (!res.ok) {
            const message = (data && (data.message || data.error)) || raw || 'Помилка створення line item';
            showError(message);
          } else {
            const id = data?.id ?? (() => { try { return JSON.parse(raw).id; } catch { return null; } })();
            if (id) {
              msg.className = 'text-emerald-600';
              msg.innerHTML = `Створено! ID: <code>${id}</code> · <button id="copyId" class="underline">скопіювати</button>`;
              ($('#copyId'))?.addEventListener('click', () => navigator.clipboard.writeText(String(id)));
            } else {
              showSuccess('Ваш line item створено. Дякуємо!');
            }
            form.reset();
            previewBox.classList.add('hidden');
            if (previewImg.src && previewImg.src.startsWith('blob:')) { try { URL.revokeObjectURL(previewImg.src); } catch {} previewImg.src = ''; }
            postResize();
          }
        } catch {
          showError('Мережева помилка. Спробуйте ще раз.');
        } finally {
          submitBtn.disabled = false;
        }
      });
    })();
  </script>
</body>
</html>