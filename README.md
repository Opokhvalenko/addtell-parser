# AdServer Backend

Backend —Å–µ—Ä–≤—ñ—Å –¥–ª—è –Ω–æ–≤–∏–Ω–Ω–æ–≥–æ –¥–æ–¥–∞—Ç–∫—É –∑ —Ä–µ–∫–ª–∞–º–æ—é, –∞–Ω–∞–ª—ñ—Ç–∏–∫–æ—é —Ç–∞ OpenTelemetry —Å–ø–æ—Å—Ç–µ—Ä–µ–∂–µ–Ω–Ω—è–º.

## üöÄ –¢–µ—Ö–Ω–æ–ª–æ–≥—ñ—ó

- **Fastify v5** - —à–≤–∏–¥–∫–∏–π –≤–µ–±-—Ñ—Ä–µ–π–º–≤–æ—Ä–∫
- **TypeScript** - —Å—Ç—Ä–æ–≥–∞ —Ç–∏–ø—ñ–∑–∞—Ü—ñ—è
- **Prisma** - ORM –¥–ª—è MongoDB
- **ClickHouse** - –∞–Ω–∞–ª—ñ—Ç–∏—á–Ω–∞ –±–∞–∑–∞ –¥–∞–Ω–∏—Ö
- **OpenTelemetry** - —Å–ø–æ—Å—Ç–µ—Ä–µ–∂–µ–Ω–Ω—è (–ª–æ–≥–∏, –º–µ—Ç—Ä–∏–∫–∏, —Ç—Ä–µ–π—Å–∏)
- **Argon2** - —Ö–µ—à—É–≤–∞–Ω–Ω—è –ø–∞—Ä–æ–ª—ñ–≤
- **JWT** - –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—è
- **Pino** - –ª–æ–≥—É–≤–∞–Ω–Ω—è

## üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç—É

```
src/
‚îú‚îÄ‚îÄ app.ts                 # –ö–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è Fastify
‚îú‚îÄ‚îÄ index.ts              # –¢–æ—á–∫–∞ –≤—Ö–æ–¥—É
‚îú‚îÄ‚îÄ config/               # –ö–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è
‚îú‚îÄ‚îÄ modules/              # –ë—ñ–∑–Ω–µ—Å-–ª–æ–≥—ñ–∫–∞
‚îÇ   ‚îú‚îÄ‚îÄ auth/             # –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—è
‚îÇ   ‚îú‚îÄ‚îÄ feed/             # –ù–æ–≤–∏–Ω–Ω—ñ —Å—Ç—Ä—ñ—á–∫–∏
‚îÇ   ‚îú‚îÄ‚îÄ adserver/         # –†–µ–∫–ª–∞–º–Ω–∏–π —Å–µ—Ä–≤–µ—Ä
‚îÇ   ‚îú‚îÄ‚îÄ stats/            # –ê–Ω–∞–ª—ñ—Ç–∏–∫–∞
‚îÇ   ‚îî‚îÄ‚îÄ uploads/          # –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ñ–∞–π–ª—ñ–≤
‚îú‚îÄ‚îÄ plugins/              # Fastify –ø–ª–∞–≥—ñ–Ω–∏
‚îú‚îÄ‚îÄ routes/               # –ú–∞—Ä—à—Ä—É—Ç–∏
‚îú‚îÄ‚îÄ telemetry/            # OpenTelemetry
‚îî‚îÄ‚îÄ utils/                # –£—Ç–∏–ª—ñ—Ç–∏
```

## üõ† –í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è

```bash
# –í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è –∑–∞–ª–µ–∂–Ω–æ—Å—Ç–µ–π
npm install

# –ì–µ–Ω–µ—Ä–∞—Ü—ñ—è Prisma –∫–ª—ñ—î–Ω—Ç–∞
npm run prisma:generate

# –ó–∞–ø—É—Å–∫ –≤ —Ä–µ–∂–∏–º—ñ —Ä–æ–∑—Ä–æ–±–∫–∏
npm run dev
```

## üîß –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è

–°—Ç–≤–æ—Ä—ñ—Ç—å —Ñ–∞–π–ª `.env`:

```env
NODE_ENV=development
HOST=0.0.0.0
PORT=3000
APP_ORIGIN=http://localhost:5173

# –ë–∞–∑–∞ –¥–∞–Ω–∏—Ö
DATABASE_URL="mongodb://localhost:27017/feeds"

# –°–µ–∫—Ä–µ—Ç–∏
JWT_SECRET=your-32-char-secret
COOKIE_SECRET=your-32-char-secret
COOKIE_SECURE=false

# ClickHouse (–æ–ø—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ)
CLICKHOUSE_URL=http://127.0.0.1:8123
CLICKHOUSE_USER=default
CLICKHOUSE_PASSWORD=changeme
CLICKHOUSE_DB=analytics

# Cron –∑–∞–≤–¥–∞–Ω–Ω—è
CRON_ENABLE=true
CRON_FEEDS_SCHEDULE=*/10 * * * *
CRON_TZ=UTC

# –§—ñ–¥–∏
DEFAULT_FEED_URL=https://hnrss.org/frontpage
FEEDS_SOURCES=["https://hnrss.org/frontpage","https://hnrss.org/newest"]

# –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è
UPLOADS_DIR=./uploads
```

## üöÄ –ó–∞–ø—É—Å–∫

### –õ–æ–∫–∞–ª—å–Ω–∏–π —Ä–æ–∑—Ä–æ–±–∫–∞

```bash
# –ó–∞–ø—É—Å–∫ –∑ hot reload
npm run dev

# –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç—ñ–≤
npm test

# –õ—ñ–Ω—Ç–∏–Ω–≥
npm run lint
```

### Docker

```bash
# –ó–∞–ø—É—Å–∫ –∑ Docker Compose
docker compose up -d

# –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å—É
docker compose ps
```

## üìä API Endpoints

### Health Check
- `GET /health` - —Å—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–µ—Ä–∞
- `GET /health/db` - —Å—Ç–∞—Ç—É—Å –±–∞–∑–∏ –¥–∞–Ω–∏—Ö
- `GET /health/clickhouse` - —Å—Ç–∞—Ç—É—Å ClickHouse

### –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—è
- `POST /api/auth/register` - —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—è
- `POST /api/auth/login` - –≤—Ö—ñ–¥
- `POST /api/auth/logout` - –≤–∏—Ö—ñ–¥
- `GET /api/auth/me` - –ø–æ—Ç–æ—á–Ω–∏–π –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á

### –ù–æ–≤–∏–Ω–Ω—ñ —Å—Ç—Ä—ñ—á–∫–∏
- `GET /api/feed` - –æ—Ç—Ä–∏–º–∞–Ω–Ω—è –Ω–æ–≤–∏–Ω
- `GET /api/article` - –æ—Ç—Ä–∏–º–∞–Ω–Ω—è —Å—Ç–∞—Ç—Ç—ñ

### –†–µ–∫–ª–∞–º–Ω–∏–π —Å–µ—Ä–≤–µ—Ä
- `POST /api/adserver/lineitems` - —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è —Ä–µ–∫–ª–∞–º–Ω–æ–≥–æ –±–ª–æ–∫—É
- `POST /api/adserver/bid` - bid endpoint
- `GET /api/beautiful-ad` - –∫—Ä–∞—Å–∏–≤–∞ —Ä–µ–∫–ª–∞–º–∞

### –ê–Ω–∞–ª—ñ—Ç–∏–∫–∞
- `POST /api/stats/ingest` - –∑–±—ñ—Ä –ø–æ–¥—ñ–π
- `GET /api/stats` - —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
- `GET /api/stats/export` - –µ–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–∏—Ö

### –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è
- `POST /api/upload` - –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ñ–∞–π–ª—ñ–≤
- `GET /uploads/*` - —Å—Ç–∞—Ç–∏—á–Ω—ñ —Ñ–∞–π–ª–∏

## üîç OpenTelemetry

–ü—Ä–æ–µ–∫—Ç –Ω–∞–ª–∞—à—Ç–æ–≤–∞–Ω–∏–π –∑ OpenTelemetry –¥–ª—è —Å–ø–æ—Å—Ç–µ—Ä–µ–∂–µ–Ω–Ω—è:

- **–õ–æ–≥–∏** - —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–≤–∞–Ω—ñ –ª–æ–≥–∏ —á–µ—Ä–µ–∑ Pino
- **–ú–µ—Ç—Ä–∏–∫–∏** - HTTP –∑–∞–ø–∏—Ç–∏, –±–∞–∑–∞ –¥–∞–Ω–∏—Ö, —Ñ–∞–π–ª–æ–≤–∞ —Å–∏—Å—Ç–µ–º–∞
- **–¢—Ä–µ–π—Å–∏** - —Ä–æ–∑–ø–æ–¥—ñ–ª–µ–Ω–µ —Ç—Ä–∞—Å—É–≤–∞–Ω–Ω—è

### –ö–æ–Ω—Å–æ–ª—å–Ω—ñ –µ–∫—Å–ø–æ—Ä—Ç–µ—Ä–∏

–í —Ä–µ–∂–∏–º—ñ —Ä–æ–∑—Ä–æ–±–∫–∏ –≤—Å—ñ –¥–∞–Ω—ñ –≤–∏–≤–æ–¥—è—Ç—å—Å—è –≤ –∫–æ–Ω—Å–æ–ª—å:
- –õ–æ–≥–∏: —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–≤–∞–Ω—ñ JSON –ª–æ–≥–∏
- –ú–µ—Ç—Ä–∏–∫–∏: HTTP –∑–∞–ø–∏—Ç–∏, —Ç—Ä–∏–≤–∞–ª—ñ—Å—Ç—å, —Å—Ç–∞—Ç—É—Å –∫–æ–¥–∏
- –¢—Ä–µ–π—Å–∏: —Ä–æ–∑–ø–æ–¥—ñ–ª–µ–Ω–µ —Ç—Ä–∞—Å—É–≤–∞–Ω–Ω—è –∑–∞–ø–∏—Ç—ñ–≤

## üß™ –¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è

```bash
# –ó–∞–ø—É—Å–∫ –≤—Å—ñ—Ö —Ç–µ—Å—Ç—ñ–≤
npm test

# –ó–∞–ø—É—Å–∫ –∑ watch —Ä–µ–∂–∏–º–æ–º
npm run test:watch

# –ü–æ–∫—Ä–∏—Ç—Ç—è –∫–æ–¥—É
npm run test:coverage
```

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ç–µ—Å—Ç—ñ–≤

- `tests/health.test.ts` - health endpoints
- `tests/auth.test.ts` - –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—è
- `tests/feed.test.ts` - –Ω–æ–≤–∏–Ω–Ω—ñ —Å—Ç—Ä—ñ—á–∫–∏
- `tests/adserver.test.ts` - —Ä–µ–∫–ª–∞–º–Ω–∏–π —Å–µ—Ä–≤–µ—Ä
- `tests/stats.test.ts` - –∞–Ω–∞–ª—ñ—Ç–∏–∫–∞
- `tests/integration.test.ts` - —ñ–Ω—Ç–µ–≥—Ä–∞—Ü—ñ–π–Ω—ñ —Ç–µ—Å—Ç–∏

## üìà –ú–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥

### –õ–æ–≥–∏
- –°—Ç—Ä—É–∫—Ç—É—Ä–æ–≤–∞–Ω—ñ JSON –ª–æ–≥–∏
- –†—ñ–≤–Ω—ñ: error, warn, info, debug
- –ö–æ–Ω—Ç–µ–∫—Å—Ç: requestId, userId, timestamp

### –ú–µ—Ç—Ä–∏–∫–∏
- `http_requests_total` - –∫—ñ–ª—å–∫—ñ—Å—Ç—å HTTP –∑–∞–ø–∏—Ç—ñ–≤
- `http_request_duration_ms` - —Ç—Ä–∏–≤–∞–ª—ñ—Å—Ç—å –∑–∞–ø–∏—Ç—ñ–≤
- `db_operations_total` - –æ–ø–µ—Ä–∞—Ü—ñ—ó –∑ –ë–î
- `process_memory_usage_bytes` - –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è –ø–∞–º'—è—Ç—ñ

### –¢—Ä–µ–π—Å–∏
- –†–æ–∑–ø–æ–¥—ñ–ª–µ–Ω–µ —Ç—Ä–∞—Å—É–≤–∞–Ω–Ω—è HTTP –∑–∞–ø–∏—Ç—ñ–≤
- –û–ø–µ—Ä–∞—Ü—ñ—ó –∑ –±–∞–∑–æ—é –¥–∞–Ω–∏—Ö
- –ó–æ–≤–Ω—ñ—à–Ω—ñ API –≤–∏–∫–ª–∏–∫–∏

## üîí –ë–µ–∑–ø–µ–∫–∞

- **CORS** - –Ω–∞–ª–∞—à—Ç–æ–≤–∞–Ω–∏–π –¥–ª—è frontend
- **JWT** - —Ç–æ–∫–µ–Ω–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó
- **HttpOnly cookies** - –±–µ–∑–ø–µ—á–Ω—ñ cookies
- **Argon2** - —Å—Ç—ñ–π–∫–µ —Ö–µ—à—É–≤–∞–Ω–Ω—è –ø–∞—Ä–æ–ª—ñ–≤
- **–í–∞–ª—ñ–¥–∞—Ü—ñ—è** - Zod —Å—Ö–µ–º–∏ –¥–ª—è –≤—Å—ñ—Ö endpoint'—ñ–≤

## üöÄ –î–µ–ø–ª–æ–π

### Environment Variables

```env
NODE_ENV=production
DATABASE_URL=mongodb://...
JWT_SECRET=production-secret
COOKIE_SECRET=production-secret
COOKIE_SECURE=true
```

### Production Build

```bash
npm run build
npm start
```

## üìù –õ—ñ—Ü–µ–Ω–∑—ñ—è

MIT License